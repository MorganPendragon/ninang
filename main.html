<!DOCTYPE html>
<html lang="en">

<head>
    <title>Our Final Webpage</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <!-- <script src="app.js"></script> -->
    <script src="night.js"></script>
    <link rel="stylesheet" href="app.css">

    <head>
        <div class="app-header">
            <div class="app-header-left">
                <span class="app-icon"></span>
                <p class="app-name">To Do List</p>
                <div class="search-wrapper">
                    <input class="search-input" id="searchBox" type="text" placeholder="Search">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor"
                        stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="feather feather-search"
                        viewBox="0 0 24 24">
                        <defs></defs>
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="M21 21l-4.35-4.35"></path>
                    </svg>
                </div>
            </div>
            <div class="app-header-right">
                <button class="checktask" id="checkTasks">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"
                        viewBox="0 0 256 256">
                        <path
                            d="M168,80a8,8,0,0,1-8-8V48H96V72a8,8,0,0,1-16,0V48H64a16,16,0,0,0-16,16V208a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V64A16,16,0,0,0,192,48H176V72A8,8,0,0,1,168,80ZM128,152a8,8,0,0,1-5.66-2.34l-24-24a8,8,0,1,1,11.32-11.32L128,132.69l37.34-37.35a8,8,0,0,1,11.32,11.32l-40,40A8,8,0,0,1,128,152Z" />
                    </svg>
                </button>

                <!-- Modal for Passed Deadlines -->
                <div id="passedDeadlinesModal" class="modal">
                    <div class="modal-content">
                        <span class="close-modal">&times;</span>
                        <h2>Tasks with Passed Deadlines</h2>
                        <div id="passedDeadlinesList"></div>
                    </div>
                </div>
                <button class="mode-switch" title="Switch Theme">
                    <svg class="moon" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                        stroke-width="2" width="24" height="24" viewBox="0 0 24 24">
                        <defs></defs>
                        <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
                </button>
                <button class="add-btn" title="Add New Project">
                    <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"
                        stroke-linejoin="round" class="feather feather-plus">
                        <line x1="12" y1="5" x2="12" y2="19" />
                        <line x1="5" y1="12" x2="19" y2="12" />
                    </svg>
                </button>
                <button class="notification-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="feather feather-bell">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
                        <path d="M13.73 21a2 2 0 0 1-3.46 0" />
                    </svg>
                </button>
                <button class="profile-btn">
                    <img src="WIN_20220429_18_12_27_Pro.jpg" />
                    <span>Jamila F.</span>
                </button>
            </div>
            <button class="messages-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="feather feather-message-circle">
                    <path
                        d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" />
                </svg>
            </button>
        </div>
    </head>

<body>
    <div class="app-container">
        <div class="app-content">
            <div class="app-sidebar">
                <a href="" class="app-sidebar-link active">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="feather feather-home">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                        <polyline points="9 22 9 12 15 12 15 22" />
                    </svg>
                </a>
                <a href="calendar.html" class="app-sidebar-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="feather feather-calendar">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                        <line x1="16" y1="2" x2="16" y2="6" />
                        <line x1="8" y1="2" x2="8" y2="6" />
                        <line x1="3" y1="10" x2="21" y2="10" />
                    </svg>
                </a>
            </div>


            <div class="projects-section">
                <div class="projects-section-header">
                    <p>Projects</p>
                    <p class="time"> </p>
                </div>
                <div class="projects-section-line">
                    <div class="projects-status">
                    </div>
                    <div class="view-actions">
                        <button class="view-btn list-view" title="List View">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="feather feather-list">
                                <line x1="8" y1="6" x2="21" y2="6" />
                                <line x1="8" y1="12" x2="21" y2="12" />
                                <line x1="8" y1="18" x2="21" y2="18" />
                                <line x1="3" y1="6" x2="3.01" y2="6" />
                                <line x1="3" y1="12" x2="3.01" y2="12" />
                                <line x1="3" y1="18" x2="3.01" y2="18" />
                            </svg>
                        </button>
                        <button class="view-btn grid-view active" title="Grid View">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="feather feather-grid">
                                <rect x="3" y="3" width="7" height="7" />
                                <rect x="14" y="3" width="7" height="7" />
                                <rect x="14" y="14" width="7" height="7" />
                                <rect x="3" y="14" width="7" height="7" />
                            </svg>
                        </button>
                    </div>
                </div>
                <!-- Modal for Task Manager -->
                <div id="taskManagerModal" class="modal">
                    <div class="modal-content">
                        <span class="close-modal">&times;</span>
                        <div class="task-manager">
                            <h2>Task Manager</h2>
                            <div class="task">
                                <input type="text" id="taskName" placeholder="Enter Task">
                                <select id="priority">
                                    <option value="High">High Priority</option>
                                    <option value="Medium">Medium Priority</option>
                                    <option value="Low">Low Priority</option>
                                </select>
                                <input type="date" id="deadline" placeholder="Deadline">

                                <label>Subtasks (max 4):</label>
                                <input type="text" class="subtask-input" placeholder="Subtask 1">
                                <input type="text" class="subtask-input" placeholder="Subtask 2">
                                <input type="text" class="subtask-input" placeholder="Subtask 3">
                                <input type="text" class="subtask-input" placeholder="Subtask 4">

                                <button id="addTask">Add Task</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Columns for tasks -->
                <div class="task-columns">
                    <div class="task-column" id="passed-deadline-column">
                        <h3>Passed Deadline</h3>
                        <div class="project-boxes" id="passed-deadline-boxes"></div>
                    </div>
                    <div class="task-column" id="near-deadline-column">
                        <h3>Near Deadline</h3>
                        <div class="project-boxes" id="near-deadline-boxes"></div>
                    </div>
                    <div class="task-column" id="completed-column">
                        <h3>Completed</h3>
                        <div class="project-boxes" id="completed-boxes"></div>
                    </div>
                </div>
                <!-- Project Boxes Section -->
                <div class="project-boxes jsGridView" id="projectBoxes">
                    <!-- Existing project boxes will be here -->
                </div>
            </div>
            <div class="messages-section">
                <button class="messages-close">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="feather feather-x-circle">
                        <circle cx="12" cy="12" r="10" />
                        <line x1="15" y1="9" x2="9" y2="15" />
                        <line x1="9" y1="9" x2="15" y2="15" />
                    </svg>
                </button>
                <div class="projects-section-header">
                    <p>Goals</p>
                </div>
                <div class="messages">
                    <div class="message-box">
                        <div class="message-content">
                            <div class="message-header">
                                <div class="item-status">
                                    <span class="status-number deadline-past">0</span>
                                    <span class="status-type">Deadline Past</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="message-box">
                        <div class="message-content">
                            <div class="message-header">
                                <div class="item-status">
                                    <span class="status-number working-on-it">0</span>
                                    <span class="status-type">Working on it</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="message-box">

                        <div class="message-content">
                            <div class="message-header">
                                <div class="item-status">
                                    <span class="status-number total-tasks">0</span>
                                    <span class="status-type">Total Task List</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="message-box">

                        <div class="message-content">
                            <div class="message-header">
                                <div class="item-status">
                                    <span class="status-number completed-tasks">0</span>
                                    <span class="status-type">Completed Task List</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</div>
</body>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const supabaseUrl = 'https://hddkqyxhojtgvlautvzx.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkZGtxeXhob2p0Z3ZsYXV0dnp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg1NTI4ODUsImV4cCI6MjA1NDEyODg4NX0.4FAo2vDcCCjgDACSnJXiDaA_gktK5XgoYTuOPcIG2Cg';
        const database = supabase.createClient(supabaseUrl, supabaseKey);

        console.log('Supabase client initialized:', database);

        let isEditMode = false; // Track if we're in edit mode
        let currentTaskId = null; // Track the task being edited

        const modal = document.getElementById('taskManagerModal');
        const addBtn = document.querySelector('.add-btn');
        const closeModalBtn = document.querySelector('.close-modal');
        const addTaskBtn = document.getElementById('addTask');

        // Open modal when "Add New Project" button is clicked
        addBtn.addEventListener('click', () => {
            modal.style.display = 'flex'; // Show the modal
            clearForm(); // Clear the form when opening the modal
        });

        // Close modal when the close button is clicked
        closeModalBtn.addEventListener('click', () => {
            modal.style.display = 'none'; // Hide the modal
        });

        // Close modal when clicking outside the modal
        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                modal.style.display = 'none'; // Hide the modal
            }
        });



        // Ensure the event listener is only added once
        addTaskBtn.removeEventListener('click', handleAddTask); // Remove existing listener
        addTaskBtn.addEventListener('click', handleAddTask); // Add new listener

        function handleAddTask() {
            addTask().then(() => {
                modal.style.display = 'none'; // Hide the modal after adding/editing
            });
        }

        function getRandomColor() {
            const colors = ["#fee4cb", "#e9e7fd", "#ffd3e2", "#c8f7dc", "#d5deff"];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        async function addTask() {
            let taskName = document.getElementById("taskName").value;
            let priority = document.getElementById("priority").value;
            let dueDate = document.getElementById("deadline").value;

            // Collect subtasks from individual inputs
            const subtaskInputs = document.querySelectorAll('.subtask-input');
            let subTasks = Array.from(subtaskInputs)
                .map(input => input.value.trim())
                .filter(subTask => subTask !== "");

            if (!taskName || !dueDate) {
                alert("Please fill in all fields.");
                return;
            }

            // Validate subtask limit (max 4 subtasks)
            if (subTasks.length > 4) {
                alert("You can only add up to 4 subtasks.");
                return;
            }

            if (isEditMode) {
                // Update existing task
                await editTask(currentTaskId, taskName, priority, dueDate, subTasks);
                isEditMode = false; // Exit edit mode
                currentTaskId = null; // Reset current task ID
                document.getElementById("addTask").textContent = "Add Task"; // Change button text back
            } else {
                // Add new task
                const { data, error } = await database
                    .from('tasks')
                    .insert([{ task_name: taskName, priority, progress: 0, due_date: dueDate }])
                    .select();

                if (error) {
                    console.error('Error inserting task:', error);
                    alert('Failed to add task. Please try again.');
                    return;
                }

                const taskId = data[0].id;

                if (subTasks.length > 0) {
                    // Insert subtasks in order
                    const subtaskInserts = subTasks.map((subTask, index) => ({
                        task_id: taskId,
                        subtask_name: subTask,
                        completed: false,
                        order: index + 1, // Add an order field to track the order
                    }));
                    await database.from('subtasks').insert(subtaskInserts);
                }
            }

            fetchTasks();
            clearForm(); // Clear the form after adding/editing
        }

        async function fetchTasks() {
            const { data: tasks, error: taskError } = await database
                .from('tasks')
                .select('*');

            if (taskError) {
                console.error('Error fetching tasks:', taskError);
                return;
            }

            console.log('Fetched tasks:', tasks); // Debugging log

            // Clear existing task boxes
            document.getElementById("passed-deadline-boxes").innerHTML = '';
            document.getElementById("near-deadline-boxes").innerHTML = '';
            document.getElementById("completed-boxes").innerHTML = '';

            let now = new Date();
            let deadlinePast = 0;
            let nearDeadline = 0;
            let completedTasks = 0;
            let totalTasks = tasks.length;

            for (let task of tasks) {
                const { data: subtasks, error: subtaskError } = await database
                    .from('subtasks')
                    .select('*')
                    .eq('task_id', task.id)
                    .order('order', { ascending: true });

                if (subtaskError) {
                    console.error('Error fetching subtasks:', subtaskError);
                    continue;
                }

                // Determine the task's status
                const taskDeadline = new Date(task.due_date);
                const daysLeft = Math.ceil((taskDeadline - now) / (1000 * 60 * 60 * 24));

                let columnId;
                if (task.progress === 100) {
                    columnId = "completed-boxes";
                    completedTasks++;
                } else if (daysLeft < 0) {
                    columnId = "passed-deadline-boxes";
                    deadlinePast++;
                } else if (daysLeft <= 1) {
                    columnId = "near-deadline-boxes";
                    nearDeadline++;
                } else {
                    // Tasks with more than 1 day left are not categorized
                    continue;
                }

                // Create the project box and append it to the appropriate column
                const projectBox = createProjectBox(task.id, task.task_name, task.priority, task.progress, task.due_date, subtasks);
                document.getElementById(columnId).appendChild(projectBox);
            }

            // Update the UI with the task counts
            document.querySelector('.status-number.deadline-past').textContent = deadlinePast;
            document.querySelector('.status-number.working-on-it').textContent = nearDeadline;
            document.querySelector('.status-number.total-tasks').textContent = totalTasks;
            document.querySelector('.status-number.completed-tasks').textContent = completedTasks;
        }

        function createProjectBox(taskId, taskName, priority, progressPercentage, dueDate, subTasks) {
            console.log('Creating project box for task:', taskName); // Debugging log

            let projectBox = document.createElement("div");
            projectBox.classList.add("project-box");

            // Change background color if the task is completed
            if (progressPercentage === 100) {
                projectBox.style.backgroundColor = '#e8f5e9'; // Light green for completed tasks
            } else {
                projectBox.style.backgroundColor = getRandomColor();
            }

            // Sort subtasks by their order
            subTasks.sort((a, b) => a.order - b.order);

            let subTaskHtml = subTasks.length > 0 ? `<p>Subtasks:</p><ul>${subTasks.map(subTask => `
            <li>
                <input type='checkbox' class='subtask-checkbox' data-task-id='${taskId}' data-subtask='${subTask.subtask_name}' ${subTask.completed ? 'checked' : ''}>
                ${subTask.subtask_name}
            </li>
        `).join('')}</ul>` : "";

            let daysLeftText = calculateDaysLeft(dueDate);

            projectBox.innerHTML = `
            <button class="edit-task" data-task-id="${taskId}">✏️</button>
            <button class='delete-task' data-task-id='${taskId}'>❌</button>
            <div class="project-box-content-header">
                <p class="box-content-header">${taskName}</p>
                <p class="box-content-subheader">${priority}</p>
            </div>
            <div class="box-progress-wrapper">
                <p class="box-progress-header">Progress</p>
                <div class="box-progress-bar">
                    <span class="box-progress" data-task-id='${taskId}' style="width: ${progressPercentage}%; background-color: ${progressPercentage === 100 ? '#4CAF50' : '#ff942e'}"></span>
                </div>
                <p class="box-progress-percentage" data-task-id='${taskId}'>${progressPercentage}%</p>
            </div>
            <div class="subtask-list">
                ${subTaskHtml}
            </div>
            <div class="project-box-footer">
                <div class="days-left" data-task-id='${taskId}' data-due-date='${dueDate}'>
                    ${progressPercentage === 100 ? "Completed" : daysLeftText}
                </div>
            </div>
        `;

            // Add event listeners for delete and edit
            projectBox.querySelector('.delete-task').addEventListener('click', () => deleteTask(taskId));
            projectBox.querySelectorAll('.delete-subtask').forEach(button => {
                button.addEventListener('click', (event) => {
                    const subtaskName = event.target.getAttribute('data-subtask');
                    deleteSubtask(taskId, subtaskName);
                });
            });

            // Add event listener for checkbox changes
            projectBox.querySelectorAll('.subtask-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (event) => {
                    const subtaskName = event.target.getAttribute('data-subtask');
                    const isCompleted = event.target.checked;
                    toggleSubtaskCompletion(taskId, subtaskName, isCompleted);
                });
            });


            async function toggleSubtaskCompletion(taskId, subtaskName, isCompleted) {
                // Update the subtask completion status in the database
                await database
                    .from('subtasks')
                    .update({ completed: isCompleted })
                    .eq('task_id', taskId)
                    .eq('subtask_name', subtaskName);

                // Recalculate the task's progress
                const subtaskCheckboxes = document.querySelectorAll(`.subtask-checkbox[data-task-id='${taskId}']`);
                const totalSubtasks = subtaskCheckboxes.length;
                const completedSubtasks = Array.from(subtaskCheckboxes).filter(checkbox => checkbox.checked).length;
                const progress = totalSubtasks === 0 ? 0 : Math.round((completedSubtasks / totalSubtasks) * 100);

                // Update the task's progress in the database
                await database
                    .from('tasks')
                    .update({ progress: progress })
                    .eq('id', taskId);

                // If all subtasks are completed, move the task to the "Completed" column
                if (progress === 100) {
                    moveTaskToCompletedColumn(taskId);
                }

                // Refresh the task list to reflect the changes
                fetchTasks();
            }

            function moveTaskToCompletedColumn(taskId) {
                const taskElement = document.querySelector(`.project-box[data-task-id='${taskId}']`);
                if (taskElement) {
                    const completedColumn = document.getElementById('completed-boxes');
                    completedColumn.appendChild(taskElement);
                }
            }

            function updateProgressBar(taskId) {
                const subtaskCheckboxes = document.querySelectorAll(`.subtask-checkbox[data-task-id='${taskId}']`);
                const progressBar = document.querySelector(`.box-progress[data-task-id='${taskId}']`);
                const progressPercentage = document.querySelector(`.box-progress-percentage[data-task-id='${taskId}']`);
                const daysLeftText = document.querySelector(`.days-left[data-task-id='${taskId}']`);

                if (!progressBar || !progressPercentage || !daysLeftText) return;

                const totalSubtasks = subtaskCheckboxes.length;
                const completedSubtasks = Array.from(subtaskCheckboxes).filter(checkbox => checkbox.checked).length;
                const progress = totalSubtasks === 0 ? 0 : Math.round((completedSubtasks / totalSubtasks) * 100);

                progressBar.style.width = `${progress}%`;
                progressPercentage.textContent = `${progress}%`;

                if (progress === 100) {
                    daysLeftText.textContent = "Completed";
                    progressBar.style.backgroundColor = '#4CAF50';
                } else {
                    const dueDate = daysLeftText.getAttribute('data-due-date');
                    const daysLeft = calculateDaysLeft(dueDate);
                    daysLeftText.textContent = daysLeft;
                    progressBar.style.backgroundColor = '#ff942e';
                }

                // Update progress in the database
                database
                    .from('tasks')
                    .update({ progress: progress })
                    .eq('id', taskId)
                    .then(({ error }) => {
                        if (error) {
                            console.error('Error updating progress:', error);
                        } else {
                            // Refresh the calendar to reflect changes
                            fetchTasksAndRenderCalendar(database, calendar);
                        }
                    });
            }

            projectBox.querySelector('.edit-task').addEventListener('click', () => {
                // Populate the form with task details
                document.getElementById("taskName").value = taskName;
                document.getElementById("priority").value = priority;
                document.getElementById("deadline").value = dueDate;

                // Populate subtask inputs
                const subtaskInputs = document.querySelectorAll('.subtask-input');
                subtaskInputs.forEach((input, index) => {
                    input.value = subTasks[index]?.subtask_name || "";
                });

                // Enter edit mode
                isEditMode = true;
                currentTaskId = taskId;
                document.getElementById("addTask").textContent = "Save Task"; // Change button text
                modal.style.display = 'flex'; // Show the modal
            });

            console.log('Project box created:', projectBox); // Debugging log
            return projectBox;
        }

        function calculateDaysLeft(dueDate) {
            const deadlineDate = new Date(dueDate);
            const today = new Date();
            const difference = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));

            if (difference < 0) {
                return "Deadline Passed";
            } else if (difference === 0) {
                return "Due Today";
            } else {
                return `${difference} Days Left`;
            }
        }

        function clearForm() {
            document.getElementById("taskName").value = "";
            document.getElementById("priority").value = "High";
            document.getElementById("deadline").value = "";
            const subtaskInputs = document.querySelectorAll('.subtask-input');
            subtaskInputs.forEach(input => input.value = "");
        }

        // Fetch tasks on page load
        fetchTasks();


        //alarm


        function updateDateTime() {
            const now = new Date();
            const options = { month: 'long', day: 'numeric', year: 'numeric' };
            document.querySelector('.time').textContent = now.toLocaleDateString('en-US', options);
        }

        // Update immediately
        updateDateTime();

        // Refresh every second (optional)
        setInterval(updateDateTime, 1000);


        setInterval(fetchTasks, 3600000);
        setTimeout(() => {
        }, 3);

        let audio; // Declare audio globally so we can stop it later

        const passedDeadlinesModal = document.getElementById('passedDeadlinesModal');
        const closePassedDeadlinesModal = passedDeadlinesModal.querySelector('.close-modal');
        const passedDeadlinesList = document.getElementById('passedDeadlinesList');

        // Open modal when "Check Status" button is clicked
        document.getElementById('checkTasks').addEventListener('click', async () => {
            const tasks = await fetchTasksWithPassedDeadlines();
            displayPassedDeadlines(tasks);

            // Only play the alert sound if there are tasks with passed deadlines
            if (tasks.length > 0) {
                playAlertSound();
            }

            passedDeadlinesModal.style.display = 'flex';
        });

        // Close modal when the close button is clicked
        closePassedDeadlinesModal.addEventListener('click', () => {
            passedDeadlinesModal.style.display = 'none';
            stopAlertSound();
        });

        // Close modal when clicking outside the modal
        window.addEventListener('click', (event) => {
            if (event.target === passedDeadlinesModal) {
                passedDeadlinesModal.style.display = 'none';
                stopAlertSound();
            }
        });

        async function fetchTasksWithPassedDeadlines() {
            const now = new Date().toISOString().split('T')[0]; // Get today's date in YYYY-MM-DD format
            const { data: tasks, error } = await database
                .from('tasks')
                .select('*')
                .lt('due_date', now) // Fetch tasks with due dates before today
                .neq('progress', 100); // Exclude completed tasks

            if (error) {
                console.error('Error fetching tasks with passed deadlines:', error);
                return [];
            }

            return tasks;
        }

        function displayPassedDeadlines(tasks) {
            passedDeadlinesList.innerHTML = ''; // Clear the list
            if (tasks.length === 0) {
                passedDeadlinesList.innerHTML = '<p>No tasks with passed deadlines.</p>';
                return;
            }

            tasks.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.classList.add('task-item');
                taskElement.innerHTML = `
            <p><strong>${task.task_name}</strong></p>
            <p>Due Date: ${task.due_date}</p>
            <p>Priority: ${task.priority}</p>
        `;
                passedDeadlinesList.appendChild(taskElement);
            });
        }

        function playAlertSound() {
            // Only play the sound if there are tasks with passed deadlines
            if (passedDeadlinesList.children.length > 0) {
                audio = new Audio('./sounds/alert.mp3');
                audio.loop = true; // Loop the sound until stopped
                audio.play().catch(error => console.error('Audio play error:', error));
            }
        }

        function stopAlertSound() {
            if (audio) {
                audio.pause();
                audio.currentTime = 0; // Reset audio to start
            }
        }

        document.getElementById("searchBox").addEventListener("input", function () {
            let filter = this.value.toLowerCase();
            let projectBoxes = document.querySelectorAll(".project-box");

            projectBoxes.forEach(box => {
                let taskTitle = box.querySelector(".box-content-header").textContent.toLowerCase();

                // Show only if the task title matches the search input
                box.style.display = taskTitle.includes(filter) ? "block" : "none";
            });
        });


    });



</script>

</html>